<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>效能優化測試頁面</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background: #1a1a1a;
        color: #e0e0e0;
        line-height: 1.6;
      }

      .test-section {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .test-section h2 {
        color: #66bb6a;
        margin-top: 0;
      }

      .metric {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .metric:last-child {
        border-bottom: none;
      }

      .metric-value {
        font-weight: bold;
        color: #90ee90;
      }

      .metric-value.warning {
        color: #ffa726;
      }

      .metric-value.error {
        color: #ef5350;
      }

      .button {
        background: linear-gradient(135deg, #66bb6a, rgba(102, 187, 106, 0.8));
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
        font-size: 14px;
      }

      .button:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(102, 187, 106, 0.3);
      }

      .log-container {
        background: #000;
        border-radius: 5px;
        padding: 15px;
        font-family: "Courier New", monospace;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
      }

      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
      }

      .status-good {
        background: #4caf50;
      }
      .status-warning {
        background: #ff9800;
      }
      .status-error {
        background: #f44336;
      }

      .progress-bar {
        width: 100%;
        height: 20px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #66bb6a, #90ee90);
        width: 0%;
        transition: width 0.3s ease;
      }

      .recommendations {
        background: rgba(255, 193, 7, 0.1);
        border-left: 4px solid #ffc107;
        padding: 15px;
        margin: 15px 0;
      }

      .recommendations h3 {
        color: #ffc107;
        margin-top: 0;
      }

      .recommendations ul {
        margin: 0;
        padding-left: 20px;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
      }
    </style>
  </head>
  <body>
    <h1>🚀 CSS 關鍵路徑優化測試</h1>

    <div class="test-section">
      <h2>📊 即時效能指標</h2>
      <div id="live-metrics">
        <div class="metric">
          <span>First Contentful Paint (FCP)</span>
          <span class="metric-value" id="fcp-value">測量中...</span>
        </div>
        <div class="metric">
          <span>Largest Contentful Paint (LCP)</span>
          <span class="metric-value" id="lcp-value">測量中...</span>
        </div>
        <div class="metric">
          <span>Cumulative Layout Shift (CLS)</span>
          <span class="metric-value" id="cls-value">測量中...</span>
        </div>
        <div class="metric">
          <span>First Input Delay (FID)</span>
          <span class="metric-value" id="fid-value">等待互動...</span>
        </div>
        <div class="metric">
          <span>Time to First Byte (TTFB)</span>
          <span class="metric-value" id="ttfb-value">測量中...</span>
        </div>
      </div>

      <div class="progress-bar">
        <div class="progress-fill" id="overall-progress"></div>
      </div>
      <div style="text-align: center; margin-top: 10px">
        <span id="overall-grade">評估中...</span>
      </div>
    </div>

    <div class="grid">
      <div class="test-section">
        <h2>🔧 優化功能測試</h2>
        <div id="optimization-status">
          <div class="metric">
            <span>關鍵路徑優化器</span>
            <span class="metric-value" id="critical-path-status">
              <span class="status-indicator status-warning"></span>檢查中...
            </span>
          </div>
          <div class="metric">
            <span>延遲載入機制</span>
            <span class="metric-value" id="lazy-loader-status">
              <span class="status-indicator status-warning"></span>檢查中...
            </span>
          </div>
          <div class="metric">
            <span>效能監控系統</span>
            <span class="metric-value" id="performance-monitor-status">
              <span class="status-indicator status-warning"></span>檢查中...
            </span>
          </div>
        </div>

        <div style="margin-top: 20px">
          <button class="button" onclick="testCriticalPath()">
            測試關鍵路徑
          </button>
          <button class="button" onclick="testLazyLoading()">
            測試延遲載入
          </button>
          <button class="button" onclick="generateReport()">生成報告</button>
          <button class="button" onclick="exportData()">匯出數據</button>
        </div>
      </div>

      <div class="test-section">
        <h2>📈 資源載入統計</h2>
        <div id="resource-stats">
          <div class="metric">
            <span>已載入資源</span>
            <span class="metric-value" id="loaded-resources">0</span>
          </div>
          <div class="metric">
            <span>總傳輸大小</span>
            <span class="metric-value" id="total-size">計算中...</span>
          </div>
          <div class="metric">
            <span>CSS 檔案</span>
            <span class="metric-value" id="css-count">0</span>
          </div>
          <div class="metric">
            <span>JavaScript 檔案</span>
            <span class="metric-value" id="js-count">0</span>
          </div>
          <div class="metric">
            <span>圖片檔案</span>
            <span class="metric-value" id="image-count">0</span>
          </div>
        </div>
      </div>
    </div>

    <div class="test-section">
      <h2>💡 優化建議</h2>
      <div id="recommendations-container">
        <p>正在分析效能數據...</p>
      </div>
    </div>

    <div class="test-section">
      <h2>📝 測試日誌</h2>
      <div class="log-container" id="test-log"></div>
      <div style="margin-top: 10px">
        <button class="button" onclick="clearLog()">清除日誌</button>
        <button class="button" onclick="downloadLog()">下載日誌</button>
      </div>
    </div>

    <script>
      class PerformanceTestSuite {
        constructor() {
          this.testLog = [];
          this.metrics = {};
          this.startTime = performance.now();

          this.init();
        }

        init() {
          this.log("🚀 效能測試套件初始化");

          // 檢查優化模組是否載入
          this.checkOptimizationModules();

          // 開始監控效能指標
          this.startMetricsMonitoring();

          // 監控資源載入
          this.monitorResourceLoading();

          // 設置定期更新
          this.setupPeriodicUpdates();

          this.log("✅ 測試套件初始化完成");
        }

        checkOptimizationModules() {
          // 檢查關鍵路徑優化器
          setTimeout(() => {
            const criticalPathStatus = document.getElementById(
              "critical-path-status"
            );
            if (window.criticalPathOptimizer) {
              criticalPathStatus.innerHTML =
                '<span class="status-indicator status-good"></span>已載入';
              this.log("✅ 關鍵路徑優化器已載入");
            } else {
              criticalPathStatus.innerHTML =
                '<span class="status-indicator status-error"></span>未載入';
              this.log("❌ 關鍵路徑優化器未載入");
            }
          }, 1000);

          // 檢查延遲載入機制
          setTimeout(() => {
            const lazyLoaderStatus =
              document.getElementById("lazy-loader-status");
            if (window.lazyLoader) {
              lazyLoaderStatus.innerHTML =
                '<span class="status-indicator status-good"></span>已載入';
              this.log("✅ 延遲載入機制已載入");
            } else {
              lazyLoaderStatus.innerHTML =
                '<span class="status-indicator status-error"></span>未載入';
              this.log("❌ 延遲載入機制未載入");
            }
          }, 1000);

          // 檢查效能監控系統
          setTimeout(() => {
            const performanceMonitorStatus = document.getElementById(
              "performance-monitor-status"
            );
            if (window.performanceMonitor) {
              performanceMonitorStatus.innerHTML =
                '<span class="status-indicator status-good"></span>已載入';
              this.log("✅ 效能監控系統已載入");
            } else {
              performanceMonitorStatus.innerHTML =
                '<span class="status-indicator status-error"></span>未載入';
              this.log("❌ 效能監控系統未載入");
            }
          }, 1000);
        }

        startMetricsMonitoring() {
          if ("PerformanceObserver" in window) {
            // 監控 Paint 事件
            const paintObserver = new PerformanceObserver((list) => {
              list.getEntries().forEach((entry) => {
                if (entry.name === "first-contentful-paint") {
                  this.updateMetric("fcp", entry.startTime);
                }
              });
            });
            paintObserver.observe({ entryTypes: ["paint"] });

            // 監控 LCP
            const lcpObserver = new PerformanceObserver((list) => {
              const entries = list.getEntries();
              const lastEntry = entries[entries.length - 1];
              this.updateMetric("lcp", lastEntry.startTime);
            });
            lcpObserver.observe({ entryTypes: ["largest-contentful-paint"] });

            // 監控 CLS
            const clsObserver = new PerformanceObserver((list) => {
              let clsValue = 0;
              list.getEntries().forEach((entry) => {
                if (!entry.hadRecentInput) {
                  clsValue += entry.value;
                }
              });
              this.updateMetric("cls", (this.metrics.cls || 0) + clsValue);
            });
            clsObserver.observe({ entryTypes: ["layout-shift"] });

            // 監控 FID
            const fidObserver = new PerformanceObserver((list) => {
              list.getEntries().forEach((entry) => {
                const fid = entry.processingStart - entry.startTime;
                this.updateMetric("fid", fid);
              });
            });
            fidObserver.observe({ entryTypes: ["first-input"] });
          }

          // 監控 Navigation Timing
          window.addEventListener("load", () => {
            const navigation = performance.getEntriesByType("navigation")[0];
            if (navigation) {
              const ttfb = navigation.responseStart - navigation.requestStart;
              this.updateMetric("ttfb", ttfb);
            }
          });
        }

        updateMetric(name, value) {
          this.metrics[name] = value;

          const element = document.getElementById(`${name}-value`);
          if (element) {
            let displayValue;
            let className = "metric-value";

            if (name === "cls") {
              displayValue = value.toFixed(4);
              if (value > 0.25) className += " error";
              else if (value > 0.1) className += " warning";
            } else {
              displayValue = `${value.toFixed(2)}ms`;
              const thresholds = {
                fcp: [1500, 2500],
                lcp: [2500, 4000],
                fid: [100, 300],
                ttfb: [200, 500],
              };

              const [good, poor] = thresholds[name] || [1000, 2000];
              if (value > poor) className += " error";
              else if (value > good) className += " warning";
            }

            element.textContent = displayValue;
            element.className = className;
          }

          this.updateOverallGrade();
          this.log(`📊 ${name.toUpperCase()}: ${displayValue || value}`);
        }

        updateOverallGrade() {
          const grades = {
            fcp: this.gradeMetric(this.metrics.fcp, [1500, 2500]),
            lcp: this.gradeMetric(this.metrics.lcp, [2500, 4000]),
            cls: this.gradeMetric(this.metrics.cls, [0.1, 0.25], true),
            fid: this.gradeMetric(this.metrics.fid, [100, 300]),
            ttfb: this.gradeMetric(this.metrics.ttfb, [200, 500]),
          };

          const validGrades = Object.values(grades).filter((g) => g !== null);
          if (validGrades.length === 0) return;

          const scoreMap = { Good: 3, "Needs Improvement": 2, Poor: 1 };
          const averageScore =
            validGrades.reduce((sum, grade) => {
              return sum + scoreMap[grade];
            }, 0) / validGrades.length;

          let overall;
          let progress;
          if (averageScore >= 2.5) {
            overall = "Good";
            progress = 100;
          } else if (averageScore >= 1.5) {
            overall = "Needs Improvement";
            progress = 60;
          } else {
            overall = "Poor";
            progress = 30;
          }

          document.getElementById(
            "overall-grade"
          ).textContent = `整體評級: ${overall}`;
          document.getElementById(
            "overall-progress"
          ).style.width = `${progress}%`;
        }

        gradeMetric(value, thresholds, lowerIsBetter = false) {
          if (value === null || value === undefined) return null;

          const [good, needsImprovement] = thresholds;

          if (lowerIsBetter) {
            if (value <= good) return "Good";
            if (value <= needsImprovement) return "Needs Improvement";
            return "Poor";
          } else {
            if (value <= good) return "Good";
            if (value <= needsImprovement) return "Needs Improvement";
            return "Poor";
          }
        }

        monitorResourceLoading() {
          const updateResourceStats = () => {
            const resources = performance.getEntriesByType("resource");

            let totalSize = 0;
            let cssCount = 0;
            let jsCount = 0;
            let imageCount = 0;

            resources.forEach((resource) => {
              totalSize += resource.transferSize || 0;

              if (resource.name.includes(".css")) cssCount++;
              else if (resource.name.includes(".js")) jsCount++;
              else if (resource.name.match(/\.(jpg|jpeg|png|gif|webp|svg)$/i))
                imageCount++;
            });

            document.getElementById("loaded-resources").textContent =
              resources.length;
            document.getElementById("total-size").textContent =
              this.formatBytes(totalSize);
            document.getElementById("css-count").textContent = cssCount;
            document.getElementById("js-count").textContent = jsCount;
            document.getElementById("image-count").textContent = imageCount;
          };

          // 初始更新
          setTimeout(updateResourceStats, 1000);

          // 定期更新
          setInterval(updateResourceStats, 5000);
        }

        setupPeriodicUpdates() {
          setInterval(() => {
            this.generateRecommendations();
          }, 10000);
        }

        generateRecommendations() {
          const recommendations = [];

          if (this.metrics.fcp > 1500) {
            recommendations.push("考慮內聯關鍵 CSS 以改善首次內容繪製時間");
          }

          if (this.metrics.lcp > 2500) {
            recommendations.push("優化最大內容元素的載入時間");
          }

          if (this.metrics.cls > 0.1) {
            recommendations.push("減少累積版面偏移，為元素設定固定尺寸");
          }

          if (this.metrics.fid > 100) {
            recommendations.push("優化 JavaScript 執行時間，考慮程式碼分割");
          }

          const container = document.getElementById(
            "recommendations-container"
          );
          if (recommendations.length > 0) {
            container.innerHTML = `
                        <div class="recommendations">
                            <h3>💡 建議優化項目</h3>
                            <ul>
                                ${recommendations
                                  .map((rec) => `<li>${rec}</li>`)
                                  .join("")}
                            </ul>
                        </div>
                    `;
          } else {
            container.innerHTML =
              '<p style="color: #4caf50;">✅ 效能表現良好，暫無優化建議</p>';
          }
        }

        formatBytes(bytes) {
          if (bytes === 0) return "0 Bytes";
          const k = 1024;
          const sizes = ["Bytes", "KB", "MB", "GB"];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return (
            parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i]
          );
        }

        log(message) {
          const timestamp = new Date().toLocaleTimeString();
          const logEntry = `[${timestamp}] ${message}`;
          this.testLog.push(logEntry);

          const logContainer = document.getElementById("test-log");
          logContainer.textContent = this.testLog.slice(-50).join("\n");
          logContainer.scrollTop = logContainer.scrollHeight;
        }

        testCriticalPath() {
          this.log("🔧 測試關鍵路徑優化...");

          if (window.criticalPathOptimizer) {
            const report = window.criticalPathOptimizer.getPerformanceReport();
            this.log(`✅ 關鍵路徑測試完成，等級: ${report.grade.overall}`);
          } else {
            this.log("❌ 關鍵路徑優化器未載入");
          }
        }

        testLazyLoading() {
          this.log("🔧 測試延遲載入機制...");

          if (window.lazyLoader) {
            const status = window.lazyLoader.getLoadStatus();
            this.log(
              `✅ 延遲載入測試完成，已載入模組: ${status.loadedModules.length}`
            );
          } else {
            this.log("❌ 延遲載入機制未載入");
          }
        }

        generateReport() {
          this.log("📊 生成效能報告...");

          const report = {
            timestamp: new Date().toISOString(),
            metrics: { ...this.metrics },
            testDuration: performance.now() - this.startTime,
            userAgent: navigator.userAgent,
            viewport: {
              width: window.innerWidth,
              height: window.innerHeight,
            },
          };

          console.log("📊 效能報告:", report);
          this.log("✅ 報告已生成，請查看控制台");
        }

        exportData() {
          const data = {
            metrics: this.metrics,
            testLog: this.testLog,
            timestamp: new Date().toISOString(),
          };

          const blob = new Blob([JSON.stringify(data, null, 2)], {
            type: "application/json",
          });

          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `performance-test-${
            new Date().toISOString().split("T")[0]
          }.json`;
          a.click();

          URL.revokeObjectURL(url);
          this.log("📁 測試數據已匯出");
        }
      }

      // 全域函數
      function testCriticalPath() {
        window.testSuite.testCriticalPath();
      }

      function testLazyLoading() {
        window.testSuite.testLazyLoading();
      }

      function generateReport() {
        window.testSuite.generateReport();
      }

      function exportData() {
        window.testSuite.exportData();
      }

      function clearLog() {
        window.testSuite.testLog = [];
        document.getElementById("test-log").textContent = "";
      }

      function downloadLog() {
        const logText = window.testSuite.testLog.join("\n");
        const blob = new Blob([logText], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `test-log-${new Date().toISOString().split("T")[0]}.txt`;
        a.click();
        URL.revokeObjectURL(url);
      }

      // 初始化測試套件
      window.addEventListener("load", () => {
        window.testSuite = new PerformanceTestSuite();
      });
    </script>
  </body>
</html>

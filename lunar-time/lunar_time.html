<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>補充能量好時機</title>
    <style>
      :root {
        /* 古書風格色彩 */
        --bg-primary: #faf7f0;
        --bg-secondary: #f5f1e8;
        --bg-card: #ffffff;
        --text-primary: #3e2723;
        --text-secondary: #5d4037;
        --border-color: rgba(93, 64, 55, 0.2);
        --theme-color: #d4af37;
        
        /* 功能色彩 */
        --auspicious-color: #2e7d32;
        --inauspicious-color: #d32f2f;
        --neutral-color: #f57c00;
        --clash-color: #8e24aa;
        
        /* 玻璃質感 */
        --glass-bg: rgba(245, 241, 232, 0.8);
        --glass-border: rgba(93, 64, 55, 0.2);
        --glass-shadow: 0 4px 20px rgba(45, 24, 16, 0.1);
      }

      /* 深色模式 */
      [data-theme="dark"] {
        --bg-primary: #1a1a1b;
        --bg-secondary: #272729;
        --bg-card: #2a2a2b;
        --text-primary: #d7dadc;
        --text-secondary: #818384;
        --border-color: #343536;
        --glass-bg: rgba(30, 30, 30, 0.8);
        --glass-border: rgba(255, 255, 255, 0.1);
        --glass-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", "微軟正黑體", "Microsoft JhengHei", system-ui, sans-serif;
        background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
        color: var(--text-primary);
        line-height: 1.6;
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
        padding: 30px;
        background: var(--glass-bg);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        border: 1px solid var(--glass-border);
        box-shadow: var(--glass-shadow);
      }

      .header h1 {
        font-size: 2.5rem;
        color: var(--theme-color);
        margin-bottom: 10px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .header-subtitle {
        color: var(--text-secondary);
        font-size: 1.1rem;
      }

      .controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        margin-bottom: 30px;
        flex-wrap: wrap;
      }

      .input-group {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 8px;
      }

      .input-group label {
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 0.9rem;
      }

      .input-group input,
      .input-group select {
        padding: 12px 16px;
        border: 2px solid var(--border-color);
        border-radius: 10px;
        background: var(--bg-card);
        color: var(--text-primary);
        font-size: 1rem;
        transition: all 0.3s ease;
        min-width: 150px;
      }

      .input-group input:focus,
      .input-group select:focus {
        outline: none;
        border-color: var(--theme-color);
        box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2);
      }

      .query-btn {
        padding: 12px 24px;
        background: linear-gradient(135deg, var(--theme-color), #f4c430);
        color: #fff;
        border: none;
        border-radius: 10px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        box-shadow: 0 4px 15px rgba(212, 175, 55, 0.3);
      }

      .query-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
      }

      .times-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .time-card {
        background: var(--bg-card);
        border-radius: 15px;
        padding: 20px;
        border: 2px solid var(--border-color);
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        min-height: auto;
        height: auto;
        overflow: visible;
      }

      .time-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        border-color: var(--theme-color);
      }

      .time-card.current {
        border: 3px solid var(--theme-color);
        background: linear-gradient(135deg, var(--bg-card) 0%, rgba(212, 175, 55, 0.05) 100%);
        box-shadow: 0 8px 30px rgba(212, 175, 55, 0.3);
        transform: scale(1.02);
      }

      .time-card.current:hover {
        transform: scale(1.02) translateY(-3px);
      }

      .time-header {
        display: flex;
        align-items: flex-start;
        gap: 20px;
        margin-bottom: 15px;
        padding-bottom: 12px;
        border-bottom: 1px solid var(--border-color);
      }

      .time-period {
        font-size: 2.2rem;
        font-weight: bold;
        color: var(--text-primary);
        font-family: "Courier New", "DejaVu Sans Mono", monospace;
        letter-spacing: 1px;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        flex-shrink: 0;
        min-width: 100px;
        white-space: pre-line;
        text-align: center;
        line-height: 1.1;
      }

      .time-info-section {
        display: flex;
        flex-direction: column;
        gap: 8px;
        flex-grow: 1;
        align-items: flex-end;
      }

      .sacrifice-status-top {
        align-self: flex-end;
      }

      .time-name-row {
        display: flex;
        align-items: center;
        gap: 8px;
        align-self: flex-end;
      }

      .time-name-container {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .time-name {
        font-size: 1.4rem;
        font-weight: bold;
        color: var(--theme-color);
        min-width: 60px;
      }

      .current-badge {
        background: var(--theme-color);
        color: white;
        font-size: 0.6rem;
        font-weight: 600;
        padding: 3px 6px;
        border-radius: 8px;
        text-shadow: none;
        box-shadow: 0 2px 4px rgba(212, 175, 55, 0.3);
        animation: pulse 2s ease-in-out infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
      }


      .sacrifice-status {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 600;
        text-align: center;
        min-width: 80px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .sacrifice-status.suitable {
        background: linear-gradient(135deg, var(--auspicious-color), #4caf50);
        color: white;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      }

      .sacrifice-status.unsuitable {
        background: linear-gradient(135deg, var(--inauspicious-color), #f44336);
        color: white;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      }

      .time-content {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 15px;
      }

      .time-section {
        margin-bottom: 8px;
        display: block;
        width: 100%;
        overflow: visible;
      }

      .section-title {
        font-weight: 600;
        margin-bottom: 6px;
        font-size: 1rem;
        display: inline-block;
        min-width: 30px;
      }

      .section-title.yi {
        color: var(--auspicious-color);
      }

      .section-title.ji {
        color: var(--inauspicious-color);
      }

      .section-content {
        display: inline-block;
        font-size: 0.95rem;
        line-height: 1.5;
        color: var(--text-primary);
        word-wrap: break-word;
        max-width: 100%;
      }

      .item-text {
        display: inline;
      }

      .item-text:not(:last-child)::after {
        content: "、";
        color: var(--text-secondary);
      }

      .zodiac-clash {
        border-top: 1px solid var(--border-color);
        padding-top: 12px;
        margin-top: 8px;
      }

      .clash-title {
        font-weight: 600;
        color: var(--clash-color);
        margin-bottom: 6px;
        font-size: 1rem;
        display: inline-block;
        min-width: 30px;
      }

      .clash-content {
        display: inline;
        font-size: 0.95rem;
        color: var(--text-primary);
      }

      .clash-item {
        margin-right: 8px;
      }

      .clash-item:not(:last-child)::after {
        content: "、";
        color: var(--text-secondary);
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
      }

      .error {
        background: rgba(211, 47, 47, 0.1);
        color: var(--inauspicious-color);
        padding: 15px;
        border-radius: 10px;
        margin: 20px 0;
        border: 1px solid rgba(211, 47, 47, 0.3);
        text-align: center;
      }

      /* 響應式設計 */
      @media (max-width: 768px) {
        body {
          padding: 10px;
        }
        
        .header h1 {
          font-size: 2rem;
        }
        
        .times-grid {
          grid-template-columns: 1fr;
          gap: 15px;
        }
        
        .time-content {
          gap: 10px;
        }
        
        .controls {
          flex-direction: column;
          gap: 15px;
        }
        
        .input-group {
          width: 100%;
          max-width: 300px;
        }
        
        .input-group input,
        .input-group select {
          min-width: auto;
          width: 100%;
        }
        
        .time-name {
          font-size: 1.2rem;
        }
        
        .time-period {
          font-size: 1.6rem;
          min-width: 80px;
        }
        
        .time-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }
        
        .time-info-section {
          align-items: flex-start;
        }

        .time-name-row {
          align-self: flex-start;
        }

        .sacrifice-status {
          align-self: flex-start;
        }
        
        .sacrifice-status {
          font-size: 0.8rem;
          padding: 4px 8px;
          min-width: 60px;
        }
      }

      @media (max-width: 480px) {
        .header {
          padding: 20px;
        }
        
        .header h1 {
          font-size: 1.8rem;
        }
        
        .time-card {
          padding: 15px;
        }
        
        .time-name {
          font-size: 1.1rem;
        }
        
        .time-period {
          font-size: 1.4rem;
          min-width: 70px;
        }
        
        .sacrifice-status {
          font-size: 0.7rem;
          padding: 3px 6px;
          min-width: 50px;
        }
        
        .current-badge {
          font-size: 0.6rem;
          padding: 3px 6px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header class="header">
        <h1>補充能量好時機</h1>
      </header>

      <div class="controls">
        <div class="input-group">
          <input type="date" id="date-input" />
        </div>
        <button class="query-btn" onclick="queryDateTime()">查詢時辰</button>
      </div>

      <div id="content">
        <div class="loading">請選擇日期並點擊查詢...</div>
      </div>
    </div>

    <!-- 載入農曆庫 -->
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.3.2/lunar.min.js"></script>
    
    <script>
      // 時辰資料
      const timeNames = ["子", "丑", "寅", "卯", "辰", "巳", "午", "未", "申", "酉", "戌", "亥"];
      const timePeriods = [
        "23:00-00:59", "01:00-02:59", "03:00-04:59", "05:00-06:59",
        "07:00-08:59", "09:00-10:59", "11:00-12:59", "13:00-14:59",
        "15:00-16:59", "17:00-18:59", "19:00-20:59", "21:00-22:59"
      ];
      
      // 生肖對應
      const zodiacAnimals = ["鼠", "牛", "虎", "兔", "龍", "蛇", "馬", "羊", "猴", "雞", "狗", "豬"];
      
      // 方位對應
      const directions = ["北", "東北", "東", "東南", "南", "西南", "西", "西北"];
      
      // 時辰宜忌資料
      const timeActivities = {
        yi: [
          ["祭祀", "祈福", "嫁娶", "安床", "沐浴", "理髮", "整手足甲", "掃舍", "塞穴"],
          ["營商", "交易", "立券", "納財", "開市", "牧養", "納畜", "教牛馬", "會親友"],
          ["出行", "移徙", "入宅", "修造", "動土", "豎柱", "上樑", "蓋屋", "合脊"],
          ["會友", "宴會", "慶典", "納采", "問名", "訂盟", "嫁娶", "冠笄", "進人口"],
          ["動土", "破土", "修墳", "安葬", "啟鑽", "除服", "成服", "移柩", "入殮"],
          ["開市", "立券", "納財", "交易", "掛匾", "出貨財", "栽種", "牧養", "畋獵"],
          ["嫁娶", "納采", "問名", "訂盟", "進人口", "冠笄", "裁衣", "合帳", "經絡"],
          ["祭祀", "祈福", "齋醮", "沐浴", "整手足甲", "掃舍", "解除", "求醫", "治病"],
          ["療病", "服藥", "針灸", "理髮", "整手足甲", "沐浴", "掃舍", "除蟲", "塞穴"],
          ["宴會", "會友", "慶典", "娛樂", "作樂", "入學", "習藝", "開光", "塑繪"],
          ["安床", "入宅", "移徙", "修造", "動土", "豎柱", "開渠", "穿井", "補垣"],
          ["冥想", "讀書", "學習", "靜思", "求學", "習藝", "作文", "考試", "療養"]
        ],
        ji: [
          ["動土", "破土", "開業", "遠行", "出貨財", "畋獵", "取魚", "結網"],
          ["嫁娶", "開市", "入宅", "移徙", "安床", "作灶", "治病", "針灸"],
          ["安葬", "修墳", "破土", "動土", "啟鑽", "移柩", "入殮", "除服"],
          ["訴訟", "爭執", "簽約", "立券", "詞訟", "求財", "開倉", "出貨財"],
          ["嫁娶", "納采", "開市", "出行", "移徙", "入宅", "安床", "作灶"],
          ["安床", "入宅", "修造", "動土", "上樑", "蓋屋", "作灶", "安門"],
          ["安葬", "修墳", "開業", "立券", "破土", "啟鑽", "移柩", "入殮"],
          ["訴訟", "爭執", "遠行", "出行", "移徙", "入宅", "詞訟", "求財"],
          ["嫁娶", "開市", "動土", "破土", "修造", "上樑", "安床", "作灶"],
          ["安葬", "修墳", "入宅", "移徙", "破土", "啟鑽", "移柩", "安床"],
          ["訴訟", "立券", "簽約", "交易", "詞訟", "爭執", "開倉", "出貨財"],
          ["開市", "出行", "遠行", "動土", "破土", "修造", "移徙", "入宅"]
        ]
      };

      // 初始化
      document.addEventListener("DOMContentLoaded", function() {
        if (typeof Lunar === 'undefined') {
          showError("農曆庫載入失敗，請檢查網路連接");
          return;
        }
        
        // 設定今日日期
        const today = new Date();
        document.getElementById('date-input').value = today.toISOString().split('T')[0];
        
        // 自動查詢當前時辰
        queryDateTime();
        
        console.log("頁面初始化完成");
      });

      // 查詢時辰
      function queryDateTime() {
        const dateInput = document.getElementById('date-input');
        const selectedDate = new Date(dateInput.value);
        
        if (isNaN(selectedDate.getTime())) {
          showError("請選擇有效的日期");
          return;
        }
        
        showLoading();
        
        try {
          const lunar = Lunar.fromDate(selectedDate);
          generateTimesDisplay(selectedDate, lunar);
        } catch (error) {
          console.error("查詢失敗:", error);
          showError("查詢失敗，請重試");
        }
      }

      // 獲取當前時辰索引
      function getCurrentTimeIndex() {
        const now = new Date();
        const hour = now.getHours();
        
        if (hour >= 23 || hour < 1) return 0; // 子時 23:00-00:59
        else if (hour >= 1 && hour < 3) return 1; // 丑時 01:00-02:59
        else if (hour >= 3 && hour < 5) return 2; // 寅時 03:00-04:59
        else if (hour >= 5 && hour < 7) return 3; // 卯時 05:00-06:59
        else if (hour >= 7 && hour < 9) return 4; // 辰時 07:00-08:59
        else if (hour >= 9 && hour < 11) return 5; // 巳時 09:00-10:59
        else if (hour >= 11 && hour < 13) return 6; // 午時 11:00-12:59
        else if (hour >= 13 && hour < 15) return 7; // 未時 13:00-14:59
        else if (hour >= 15 && hour < 17) return 8; // 申時 15:00-16:59
        else if (hour >= 17 && hour < 19) return 9; // 酉時 17:00-18:59
        else if (hour >= 19 && hour < 21) return 10; // 戌時 19:00-20:59
        else return 11; // 亥時 21:00-22:59
      }

      // 生成時辰顯示
      function generateTimesDisplay(solarDate, lunarDate) {
        const content = document.getElementById('content');
        const currentTimeIndex = getCurrentTimeIndex();
        const today = new Date();
        const isToday = solarDate.toDateString() === today.toDateString();
        
        const timesHTML = timeNames.map((timeName, index) => {
          const timeData = getTimeData(solarDate, lunarDate, index);
          const isCurrent = isToday && index === currentTimeIndex;
          return createTimeCard(timeName, index, timeData, isCurrent);
        }).join('');
        
        content.innerHTML = `<div class="times-grid">${timesHTML}</div>`;
        
        // 如果是今天，滾動到當前時辰
        if (isToday) {
          setTimeout(() => {
            const currentCard = document.querySelector('.time-card.current');
            if (currentCard) {
              currentCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
          }, 100);
        }
      }

      // 獲取時辰資料
      function getTimeData(solarDate, lunarDate, timeIndex) {
        try {
          // 嘗試從農曆庫獲取真實的時辰宜忌資料
          let yiItems = [];
          let jiItems = [];
          
          // 獲取農曆日期的宜忌
          if (lunarDate && lunarDate.getDayYi) {
            const dayYi = lunarDate.getDayYi();
            if (dayYi && dayYi.length > 0) {
              // 根據時辰索引選擇部分宜事
              const startIndex = (timeIndex * 3) % dayYi.length;
              yiItems = dayYi.slice(startIndex, startIndex + 6).concat(
                dayYi.slice(0, Math.max(0, startIndex + 6 - dayYi.length))
              );
            }
          }
          
          if (lunarDate && lunarDate.getDayJi) {
            const dayJi = lunarDate.getDayJi();
            if (dayJi && dayJi.length > 0) {
              // 根據時辰索引選擇部分忌事
              const startIndex = (timeIndex * 2) % dayJi.length;
              jiItems = dayJi.slice(startIndex, startIndex + 5).concat(
                dayJi.slice(0, Math.max(0, startIndex + 5 - dayJi.length))
              );
            }
          }
          
          // 如果農曆庫沒有資料，使用預設資料
          if (yiItems.length === 0) {
            yiItems = timeActivities.yi[timeIndex] || [];
          }
          if (jiItems.length === 0) {
            jiItems = timeActivities.ji[timeIndex] || [];
          }
          
          // 計算沖煞生肖 - 使用農曆庫的生肖計算
          let clashZodiac = zodiacAnimals[(timeIndex + 6) % 12];
          if (lunarDate && lunarDate.getDayChong) {
            const dayChong = lunarDate.getDayChong();
            if (dayChong) {
              clashZodiac = dayChong.replace('沖', '');
            }
          }
          
          // 計算煞方 - 使用農曆庫的煞方計算
          let direction = directions[timeIndex % 8];
          if (lunarDate && lunarDate.getDaySha) {
            const daySha = lunarDate.getDaySha();
            if (daySha) {
              direction = daySha.replace('煞', '');
            }
          }
          
          // 檢查祭祀狀態
          let sacrificeStatus = null;
          if (yiItems.some(item => item.includes('祭祀') || item.includes('祈福'))) {
            sacrificeStatus = "宜祭祀";
          } else if (jiItems.some(item => item.includes('祭祀') || item.includes('祈福'))) {
            sacrificeStatus = "忌祭祀";
          }
          
          console.log(`時辰 ${timeIndex} 資料:`, {
            yi: yiItems,
            ji: jiItems,
            clashZodiac,
            direction,
            sacrificeStatus
          });
          
          return {
            yi: yiItems.length > 0 ? yiItems : ["無特殊宜事"],
            ji: jiItems.length > 0 ? jiItems : ["無特殊忌事"],
            clashZodiac: clashZodiac,
            direction: direction,
            sacrificeStatus: sacrificeStatus
          };
        } catch (error) {
          console.error('獲取時辰資料失敗:', error);
          // 回退到預設資料
          return {
            yi: timeActivities.yi[timeIndex] || ["無特殊宜事"],
            ji: timeActivities.ji[timeIndex] || ["無特殊忌事"],
            clashZodiac: zodiacAnimals[(timeIndex + 6) % 12],
            direction: directions[timeIndex % 8],
            sacrificeStatus: null
          };
        }
      }

      // 創建時辰卡片
      function createTimeCard(timeName, index, timeData, isCurrent = false) {
        const currentClass = isCurrent ? ' current' : '';
        const currentBadge = isCurrent ? '<span class="current-badge">目前時辰</span>' : '';
        
        // 處理時間格式，將 - 改為換行或更清楚的分隔
        const timeParts = timePeriods[index].split('-');
        const formattedTime = `${timeParts[0]}\n${timeParts[1]}`;
        
        const sacrificeStatusHTML = timeData.sacrificeStatus ? 
          `<div class="sacrifice-status ${timeData.sacrificeStatus.includes('宜') ? 'suitable' : 'unsuitable'}">${timeData.sacrificeStatus}</div>` : '';
        
        return `
          <div class="time-card${currentClass}">
            <div class="time-header">
              <div class="time-period">${formattedTime}</div>
              <div class="time-info-section">
                <div class="time-name-row">
                  <div class="time-name">${timeName}時</div>
                  ${currentBadge}
                </div>
                ${sacrificeStatusHTML}
              </div>
            </div>
            
            <div class="time-content">
              <div class="time-section yi">
                <span class="section-title yi">宜：</span>
                <span class="section-content">
                  ${timeData.yi.map(item => `<span class="item-text">${item}</span>`).join('')}
                </span>
              </div>
              
              <div class="time-section ji">
                <span class="section-title ji">忌：</span>
                <span class="section-content">
                  ${timeData.ji.map(item => `<span class="item-text">${item}</span>`).join('')}
                </span>
              </div>
            </div>
            
            <div class="zodiac-clash">
              <span class="clash-title">沖：</span>
              <span class="clash-content">
                <span class="clash-item">${timeData.clashZodiac}</span>
                <span class="clash-item">煞${timeData.direction}</span>
              </span>
            </div>
          </div>
        `;
      }

      // 顯示載入中
      function showLoading() {
        document.getElementById('content').innerHTML = '<div class="loading">正在查詢時辰資料...</div>';
      }

      // 顯示錯誤
      function showError(message) {
        document.getElementById('content').innerHTML = `<div class="error">${message}</div>`;
      }

      // 主題切換監聽
      window.addEventListener('message', function(event) {
        if (event.data && event.data.type === 'THEME_CHANGE') {
          const theme = event.data.theme;
          document.body.setAttribute('data-theme', theme);
          console.log('子頁面主題已切換至:', theme);
        }
      });

      // 初始化主題 - 預設為淺色模式
      document.body.setAttribute('data-theme', 'light');
    </script>
  </body>
</html>
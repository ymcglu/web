<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>農曆時辰宜忌查詢</title>
    <style>
      :root {
        --bg-primary: #1a1a1b;
        --bg-secondary: #272729;
        --text-primary: #d7dadc;
        --text-secondary: #818384;
        --border-color: #343536;
        --theme-color: #7a8471;
        --theme-color-rgb: 122, 132, 113;
        --auspicious-color: #6b8e5a;
        --inauspicious-color: #a67c7c;
        --neutral-color: #b8956b;
        --selected-color: #6b8db5;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", "微軟正黑體", "Microsoft JhengHei", system-ui,
          sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        padding: 20px;
        min-height: 100vh;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
        padding: 20px;
        background: rgba(var(--theme-color-rgb), 0.1);
        border-radius: 15px;
        border: 1px solid rgba(255, 255, 255, 0.05);
      }

      .header h1 {
        font-size: 2.5rem;
        background: linear-gradient(135deg, var(--theme-color), #8a9481);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 20px;
      }

      .controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .input-group {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
      }

      .input-group label {
        font-size: 0.9rem;
        color: var(--text-secondary);
      }

      .date-input,
      .time-select {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 10px 15px;
        color: var(--text-primary);
        font-size: 1rem;
        min-width: 180px;
      }

      .date-input:focus,
      .time-select:focus {
        outline: none;
        border-color: var(--theme-color);
        box-shadow: 0 0 0 2px rgba(var(--theme-color-rgb), 0.2);
      }

      .query-btn {
        background: var(--theme-color);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 12px 24px;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 20px;
      }

      .query-btn:hover {
        background: #8a9481;
        transform: translateY(-2px);
      }

      .date-info {
        font-size: 1.1rem;
        color: var(--text-secondary);
        margin-top: 15px;
      }

      .selected-time-info {
        background: var(--bg-secondary);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 30px;
        border: 2px solid var(--selected-color);
        box-shadow: 0 0 20px rgba(107, 141, 181, 0.2);
      }

      .selected-time-info h3 {
        color: var(--selected-color);
        margin-bottom: 15px;
        font-size: 1.3rem;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .time-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 15px;
      }

      .yi-ji-section h4 {
        margin-bottom: 10px;
        font-size: 1.1rem;
      }

      .yi-section h4 {
        color: var(--auspicious-color);
      }

      .ji-section h4 {
        color: var(--inauspicious-color);
      }

      .yi-ji-items {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .yi-item {
        background: rgba(107, 142, 90, 0.15);
        color: var(--auspicious-color);
        border: 1px solid rgba(107, 142, 90, 0.4);
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 0.9rem;
      }

      .ji-item {
        background: rgba(166, 124, 124, 0.15);
        color: var(--inauspicious-color);
        border: 1px solid rgba(166, 124, 124, 0.4);
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 0.9rem;
      }

      .sacrifice-analysis {
        background: rgba(var(--theme-color-rgb), 0.1);
        border-radius: 10px;
        padding: 15px;
        border-left: 4px solid var(--theme-color);
      }

      .sacrifice-status {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
        font-weight: bold;
        font-size: 1.1rem;
      }

      .sacrifice-status.suitable {
        color: var(--auspicious-color);
      }

      .sacrifice-status.unsuitable {
        color: var(--inauspicious-color);
      }

      .sacrifice-status.neutral {
        color: var(--neutral-color);
      }

      .all-times-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 15px;
      }

      .time-card {
        background: var(--bg-secondary);
        border-radius: 12px;
        padding: 15px;
        border: 1px solid var(--border-color);
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .time-card:hover {
        transform: translateY(-2px);
        border-color: var(--theme-color);
        box-shadow: 0 8px 25px rgba(var(--theme-color-rgb), 0.2);
      }

      .time-card.selected {
        border: 2px solid var(--selected-color);
        background: rgba(107, 141, 181, 0.1);
      }

      .time-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .time-name {
        font-size: 1.2rem;
        font-weight: bold;
        color: var(--theme-color);
      }

      /* 根據祭祀狀態顯示不同顏色的時辰名稱 */
      .time-card.sacrifice-suitable .time-name {
        color: var(--auspicious-color);
      }

      .time-card.sacrifice-unsuitable .time-name {
        color: var(--inauspicious-color);
      }

      .time-card.sacrifice-neutral .time-name {
        color: var(--neutral-color);
      }

      .time-period {
        font-size: 0.9rem;
        color: var(--text-secondary);
        background: var(--bg-primary);
        padding: 4px 8px;
        border-radius: 12px;
      }

      /* 當前時辰的時間標示用不同顏色 */
      .time-card.current .time-period {
        color: var(--neutral-color);
        background: rgba(184, 149, 107, 0.2);
        font-weight: bold;
      }

      .time-sacrifice-status {
        font-size: 0.9rem;
        padding: 5px 10px;
        border-radius: 6px;
        text-align: center;
        margin-bottom: 8px;
      }

      .time-sacrifice-status.suitable {
        background: rgba(107, 142, 90, 0.15);
        color: var(--auspicious-color);
        border: 1px solid rgba(107, 142, 90, 0.4);
      }

      .time-sacrifice-status.unsuitable {
        background: rgba(166, 124, 124, 0.15);
        color: var(--inauspicious-color);
        border: 1px solid rgba(166, 124, 124, 0.4);
      }

      .time-sacrifice-status.neutral {
        background: rgba(184, 149, 107, 0.15);
        color: var(--neutral-color);
        border: 1px solid rgba(184, 149, 107, 0.4);
      }

      .loading,
      .error {
        text-align: center;
        padding: 40px;
        font-size: 1.1rem;
      }

      .error {
        color: var(--inauspicious-color);
        background: rgba(166, 124, 124, 0.1);
        border-radius: 10px;
        border: 1px solid var(--inauspicious-color);
      }

      @media (max-width: 768px) {
        .controls {
          flex-direction: column;
          gap: 15px;
        }

        .time-details {
          grid-template-columns: 1fr;
        }

        .all-times-grid {
          grid-template-columns: 1fr;
        }

        .header h1 {
          font-size: 2rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header class="header">
        <h1>農曆時辰宜忌查詢</h1>
        <div class="controls">
          <div class="input-group">
            <label for="date-input">選擇日期</label>
            <input type="date" id="date-input" class="date-input" />
          </div>
          <div class="input-group">
            <label for="time-select">選擇時辰</label>
            <select id="time-select" class="time-select">
              <option value="0">子時 (23:00-00:59)</option>
              <option value="1">丑時 (01:00-02:59)</option>
              <option value="2">寅時 (03:00-04:59)</option>
              <option value="3">卯時 (05:00-06:59)</option>
              <option value="4">辰時 (07:00-08:59)</option>
              <option value="5">巳時 (09:00-10:59)</option>
              <option value="6">午時 (11:00-12:59)</option>
              <option value="7">未時 (13:00-14:59)</option>
              <option value="8">申時 (15:00-16:59)</option>
              <option value="9">酉時 (17:00-18:59)</option>
              <option value="10">戌時 (19:00-20:59)</option>
              <option value="11">亥時 (21:00-22:59)</option>
            </select>
          </div>
          <button onclick="queryDateTime()" class="query-btn">查詢</button>
          <button
            onclick="goToCurrentTime()"
            class="query-btn"
            style="background: var(--neutral-color)"
          >
            回到當前時辰
          </button>
        </div>
        <div class="date-info" id="date-info"></div>
      </header>

      <div id="loading" class="loading" style="display: none">
        <p>正在載入農曆資料...</p>
      </div>

      <div id="error" class="error" style="display: none"></div>

      <div id="content" style="display: none">
        <!-- 選定時辰詳細信息 -->
        <div class="selected-time-info" id="selected-time-info">
          <h3>選定時辰詳情</h3>
          <div id="selected-time-content"></div>
        </div>

        <!-- 所有時辰概覽 -->
        <div class="all-times-grid" id="all-times-grid"></div>
      </div>
    </div>

    <script type="module">
      // 導入 tyme4ts 庫
      // 全域變數
      let tyme = null;

      // 時辰名稱和時間段
      const timeNames = [
        "子",
        "丑",
        "寅",
        "卯",
        "辰",
        "巳",
        "午",
        "未",
        "申",
        "酉",
        "戌",
        "亥",
      ];
      const timePeriods = [
        "23:00-00:59",
        "01:00-02:59",
        "03:00-04:59",
        "05:00-06:59",
        "07:00-08:59",
        "09:00-10:59",
        "11:00-12:59",
        "13:00-14:59",
        "15:00-16:59",
        "17:00-18:59",
        "19:00-20:59",
        "21:00-22:59",
      ];

      let currentLunarDay = null;
      let selectedTimeIndex = 0;

      // 初始化
      document.addEventListener("DOMContentLoaded", async function () {
        try {
          // 載入 tyme4ts 庫
          tyme = await import("./tyme4ts.mjs");
          console.log("tyme4ts 庫載入成功");

          // 初始化日期時間
          initializeDateTime();
          queryDateTime();
        } catch (error) {
          console.error("tyme4ts 庫載入失敗:", error);
          showError("tyme4ts 庫載入失敗，請確保在 HTTP 服務器環境下運行此頁面");
        }
      });

      // 初始化日期和時辰
      function initializeDateTime() {
        const now = new Date();

        // 設定日期
        const dateInput = document.getElementById("date-input");
        dateInput.value = now.toISOString().split("T")[0];

        // 設定當前時辰
        const timeSelect = document.getElementById("time-select");
        const currentTimeIndex = getCurrentTimeIndex(now.getHours());
        timeSelect.value = currentTimeIndex;
        selectedTimeIndex = currentTimeIndex;

        console.log("初始化完成 - 當前時辰:", timeNames[currentTimeIndex]);
      }

      // 根據小時獲取時辰索引
      function getCurrentTimeIndex(hour) {
        if (hour >= 23 || hour < 1) return 0; // 子時
        if (hour >= 1 && hour < 3) return 1; // 丑時
        if (hour >= 3 && hour < 5) return 2; // 寅時
        if (hour >= 5 && hour < 7) return 3; // 卯時
        if (hour >= 7 && hour < 9) return 4; // 辰時
        if (hour >= 9 && hour < 11) return 5; // 巳時
        if (hour >= 11 && hour < 13) return 6; // 午時
        if (hour >= 13 && hour < 15) return 7; // 未時
        if (hour >= 15 && hour < 17) return 8; // 申時
        if (hour >= 17 && hour < 19) return 9; // 酉時
        if (hour >= 19 && hour < 21) return 10; // 戌時
        if (hour >= 21 && hour < 23) return 11; // 亥時
        return 0;
      }

      // 查詢日期時辰
      async function queryDateTime() {
        if (!tyme) {
          showError("tyme4ts 庫尚未載入，請稍後再試");
          return;
        }

        const dateInput = document.getElementById("date-input");
        const timeSelect = document.getElementById("time-select");

        const selectedDate = new Date(dateInput.value);
        selectedTimeIndex = parseInt(timeSelect.value);

        if (isNaN(selectedDate.getTime())) {
          showError("請選擇有效的日期");
          return;
        }

        showLoading();

        try {
          console.log(
            "查詢日期:",
            selectedDate,
            "時辰索引:",
            selectedTimeIndex
          );

          // 使用 tyme4ts 獲取農曆資料
          const solar = tyme.SolarDay.fromYmd(
            selectedDate.getFullYear(),
            selectedDate.getMonth() + 1,
            selectedDate.getDate()
          );

          currentLunarDay = solar.getLunarDay();
          console.log("農曆日期對象:", currentLunarDay);

          // 更新頁面內容
          updateDateInfo(solar, currentLunarDay);
          updateSelectedTimeInfo();
          updateAllTimesGrid();

          showContent();
        } catch (error) {
          console.error("查詢失敗:", error);
          showError("查詢農曆資料失敗：" + error.message);
        }
      }

      // 更新日期資訊
      function updateDateInfo(solar, lunar) {
        const dateInfo = document.getElementById("date-info");
        const solarStr = `${solar.getYear()}年${solar.getMonth()}月${solar.getDay()}日`;
        const lunarStr = `${lunar.getYear()}年${lunar.getMonth()}月${lunar.getDay()}日`;
        const weekday = solar.getWeek().getName();

        dateInfo.innerHTML = `
                <div><strong>公曆:</strong> ${solarStr} (${weekday})</div>
                <div><strong>農曆:</strong> ${lunarStr}</div>
            `;
      }

      // 更新選定時辰信息
      function updateSelectedTimeInfo() {
        if (!currentLunarDay) return;

        const selectedTimeContent = document.getElementById(
          "selected-time-content"
        );
        console.log("選定時辰內容元素:", selectedTimeContent);
        const timeName = timeNames[selectedTimeIndex];
        const timePeriod = timePeriods[selectedTimeIndex];

        try {
          const lunarHours = currentLunarDay.getHours();
          console.log("農曆時辰數組:", lunarHours);
          console.log("選定時辰索引:", selectedTimeIndex);
          const lunarHour = lunarHours[selectedTimeIndex];
          console.log("選定的農曆時辰對象:", lunarHour);

          if (!lunarHour) {
            selectedTimeContent.innerHTML = "<p>無法獲取該時辰的資料</p>";
            return;
          }

          const recommendsRaw = lunarHour.getRecommends();
          const avoidsRaw = lunarHour.getAvoids();
          console.log("原始宜事對象:", recommendsRaw);
          console.log("原始忌事對象:", avoidsRaw);

          const recommends = recommendsRaw.map((item) => {
            if (typeof item === "string") return item;
            if (item.getName) return item.getName();
            if (item.name) return item.name;
            return item.toString();
          });
          const avoids = avoidsRaw.map((item) => {
            if (typeof item === "string") return item;
            if (item.getName) return item.getName();
            if (item.name) return item.name;
            return item.toString();
          });
          console.log("處理後宜事:", recommends);
          console.log("處理後忌事:", avoids);
          const sacrificeStatus = analyzeSacrificeStatus(recommends, avoids);
          console.log("祭祀狀態:", sacrificeStatus);

          selectedTimeContent.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="color: var(--selected-color); font-size: 1.4rem;">${timeName}時 (${timePeriod})</h4>
                        <div class="sacrifice-status ${sacrificeStatus.class}">
                            <span>${sacrificeStatus.icon}</span>
                            <span>${sacrificeStatus.text}</span>
                        </div>
                    </div>
                    <div class="time-details">
                        <div class="yi-ji-section yi-section">
                            <h4>✅ 宜事</h4>
                            <div class="yi-ji-items">
                                ${
                                  recommends.length > 0
                                    ? recommends
                                        .map(
                                          (item) =>
                                            `<span class="yi-item">${item}</span>`
                                        )
                                        .join("")
                                    : '<span style="color: var(--text-secondary);">無特別宜事</span>'
                                }
                            </div>
                        </div>
                        <div class="yi-ji-section ji-section">
                            <h4>❌ 忌事</h4>
                            <div class="yi-ji-items">
                                ${
                                  avoids.length > 0
                                    ? avoids
                                        .map(
                                          (item) =>
                                            `<span class="ji-item">${item}</span>`
                                        )
                                        .join("")
                                    : '<span style="color: var(--text-secondary);">無特別忌事</span>'
                                }
                            </div>
                        </div>
                    </div>
                    <div class="sacrifice-analysis">
                        <h4 style="color: var(--theme-color); margin-bottom: 8px;">祭祀建議</h4>
                        <p style="line-height: 1.6;">${
                          sacrificeStatus.advice
                        }</p>
                    </div>
                `;
          console.log("HTML 已設置到元素中");
        } catch (error) {
          console.error("更新選定時辰信息失敗:", error);
          selectedTimeContent.innerHTML =
            '<p style="color: var(--inauspicious-color);">載入時辰資料失敗</p>';
        }
      }

      // 更新所有時辰網格
      function updateAllTimesGrid() {
        if (!currentLunarDay) return;

        const allTimesGrid = document.getElementById("all-times-grid");
        const currentHour = new Date().getHours();
        const currentTimeIndex = getCurrentTimeIndex(currentHour);

        try {
          const lunarHours = currentLunarDay.getHours();
          let gridHtml = "";

          for (let i = 0; i < 12; i++) {
            const timeName = timeNames[i];
            const timePeriod = timePeriods[i];
            const lunarHour = lunarHours[i];

            let cardClasses = "time-card";
            let timeLabel = `${timeName}時`;

            if (i === selectedTimeIndex) {
              cardClasses += " selected";
            }

            if (i === currentTimeIndex) {
              cardClasses += " current";
            }

            let sacrificeStatusHtml = "";
            if (lunarHour) {
              const recommendsRaw = lunarHour.getRecommends();
              const avoidsRaw = lunarHour.getAvoids();

              const recommends = recommendsRaw.map((item) => {
                if (typeof item === "string") return item;
                if (item.getName) return item.getName();
                if (item.name) return item.name;
                return item.toString();
              });
              const avoids = avoidsRaw.map((item) => {
                if (typeof item === "string") return item;
                if (item.getName) return item.getName();
                if (item.name) return item.name;
                return item.toString();
              });
              const sacrificeStatus = analyzeSacrificeStatus(
                recommends,
                avoids
              );

              // 根據祭祀狀態添加對應的 CSS 類
              if (sacrificeStatus.class === "suitable") {
                cardClasses += " sacrifice-suitable";
              } else if (sacrificeStatus.class === "unsuitable") {
                cardClasses += " sacrifice-unsuitable";
              } else {
                cardClasses += " sacrifice-neutral";
              }

              sacrificeStatusHtml = `
                            <div class="time-sacrifice-status ${sacrificeStatus.class}">
                                ${sacrificeStatus.icon} ${sacrificeStatus.text}
                            </div>
                        `;
            }

            gridHtml += `
                        <div class="${cardClasses}" onclick="selectTime(${i})">
                            <div class="time-card-header">
                                <div class="time-name">${timeLabel}</div>
                                <div class="time-period">${timePeriod}</div>
                            </div>
                            ${sacrificeStatusHtml}
                        </div>
                    `;
          }

          allTimesGrid.innerHTML = gridHtml;
        } catch (error) {
          console.error("更新時辰網格失敗:", error);
          allTimesGrid.innerHTML = '<div class="error">載入時辰資料失敗</div>';
        }
      }

      // 分析祭祀適宜性
      function analyzeSacrificeStatus(recommends, avoids) {
        const sacrificeKeywords = [
          "祭祀",
          "祈福",
          "拜神",
          "祭拜",
          "上香",
          "燒香",
          "敬神",
          "祈願",
          "祈禱",
        ];

        const suitableForSacrifice = recommends.some((item) =>
          sacrificeKeywords.some((keyword) => item.includes(keyword))
        );

        const tabooForSacrifice = avoids.some((item) =>
          sacrificeKeywords.some((keyword) => item.includes(keyword))
        );

        if (suitableForSacrifice) {
          return {
            class: "suitable",
            icon: "✅",
            text: "適合祭祀",
            advice:
              "此時辰適宜祭祀祈福，可進行祭拜儀式，準備香燭供品，虔誠祭拜可得神靈庇佑。",
          };
        } else if (tabooForSacrifice) {
          return {
            class: "unsuitable",
            icon: "❌",
            text: "不宜祭祀",
            advice: "此時辰不宜進行祭祀活動，建議選擇其他時辰，以免衝撞神靈。",
          };
        } else {
          return {
            class: "neutral",
            icon: "⚠️",
            text: "可謹慎祭祀",
            advice:
              "此時辰無明確祭祀宜忌，可進行一般性祭拜，但需保持恭敬虔誠之心。",
          };
        }
      }

      // 選擇時辰
      function selectTime(timeIndex) {
        selectedTimeIndex = timeIndex;
        const timeSelect = document.getElementById("time-select");
        timeSelect.value = timeIndex;

        updateSelectedTimeInfo();
        updateAllTimesGrid();
      }

      // 回到當前時辰
      function goToCurrentTime() {
        const now = new Date();
        const currentTimeIndex = getCurrentTimeIndex(now.getHours());

        // 設定日期為今天
        const dateInput = document.getElementById("date-input");
        dateInput.value = now.toISOString().split("T")[0];

        // 選擇當前時辰
        selectTime(currentTimeIndex);

        // 重新查詢資料
        queryDateTime();
      }

      // 顯示載入中
      function showLoading() {
        document.getElementById("loading").style.display = "block";
        document.getElementById("error").style.display = "none";
        document.getElementById("content").style.display = "none";
      }

      // 顯示錯誤
      function showError(message) {
        document.getElementById("loading").style.display = "none";
        document.getElementById("error").style.display = "block";
        document.getElementById("error").textContent = message;
        document.getElementById("content").style.display = "none";
      }

      // 顯示內容
      function showContent() {
        document.getElementById("loading").style.display = "none";
        document.getElementById("error").style.display = "none";
        document.getElementById("content").style.display = "block";
      }

      // 將函數暴露到全域作用域
      window.queryDateTime = queryDateTime;
      window.selectTime = selectTime;
      window.goToCurrentTime = goToCurrentTime;
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è¾²æ›†æ™‚è¾°å®œå¿ŒæŸ¥è©¢</title>
    <style>
      :root {
        --bg-primary: #1a1a1b;
        --bg-secondary: #272729;
        --text-primary: #d7dadc;
        --text-secondary: #818384;
        --border-color: #343536;
        --theme-color: #66bb6a;
        --theme-color-rgb: 102, 187, 106;
        --auspicious-color: #4caf50;
        --inauspicious-color: #f44336;
        --neutral-color: #ff9800;
        --selected-color: #2196f3;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", "å¾®è»Ÿæ­£é»‘é«”", "Microsoft JhengHei", system-ui,
          sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        padding: 20px;
        min-height: 100vh;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
        padding: 20px;
        background: rgba(var(--theme-color-rgb), 0.1);
        border-radius: 15px;
        border: 1px solid rgba(255, 255, 255, 0.05);
      }

      .header h1 {
        font-size: 2.5rem;
        background: linear-gradient(135deg, var(--theme-color), #81c784);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 20px;
      }

      .controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
      }

      .input-group {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
      }

      .input-group label {
        font-size: 0.9rem;
        color: var(--text-secondary);
      }

      .date-input,
      .time-select {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 10px 15px;
        color: var(--text-primary);
        font-size: 1rem;
        min-width: 180px;
      }

      .date-input:focus,
      .time-select:focus {
        outline: none;
        border-color: var(--theme-color);
        box-shadow: 0 0 0 2px rgba(var(--theme-color-rgb), 0.2);
      }

      .query-btn {
        background: var(--theme-color);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 12px 24px;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 20px;
      }

      .query-btn:hover {
        background: #81c784;
        transform: translateY(-2px);
      }

      .date-info {
        font-size: 1.1rem;
        color: var(--text-secondary);
        margin-top: 15px;
      }

      .selected-time-info {
        background: var(--bg-secondary);
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 30px;
        border: 2px solid var(--selected-color);
        box-shadow: 0 0 20px rgba(33, 150, 243, 0.2);
      }

      .selected-time-info h3 {
        color: var(--selected-color);
        margin-bottom: 15px;
        font-size: 1.3rem;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .time-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 15px;
      }

      .yi-ji-section h4 {
        margin-bottom: 10px;
        font-size: 1.1rem;
      }

      .yi-section h4 {
        color: var(--auspicious-color);
      }

      .ji-section h4 {
        color: var(--inauspicious-color);
      }

      .yi-ji-items {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .yi-item {
        background: rgba(76, 175, 80, 0.2);
        color: var(--auspicious-color);
        border: 1px solid var(--auspicious-color);
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 0.9rem;
      }

      .ji-item {
        background: rgba(244, 67, 54, 0.2);
        color: var(--inauspicious-color);
        border: 1px solid var(--inauspicious-color);
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 0.9rem;
      }

      .sacrifice-analysis {
        background: rgba(var(--theme-color-rgb), 0.1);
        border-radius: 10px;
        padding: 15px;
        border-left: 4px solid var(--theme-color);
      }

      .sacrifice-status {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
        font-weight: bold;
        font-size: 1.1rem;
      }

      .sacrifice-status.suitable {
        color: var(--auspicious-color);
      }

      .sacrifice-status.unsuitable {
        color: var(--inauspicious-color);
      }

      .sacrifice-status.neutral {
        color: var(--neutral-color);
      }

      .all-times-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 15px;
      }

      .time-card {
        background: var(--bg-secondary);
        border-radius: 12px;
        padding: 15px;
        border: 1px solid var(--border-color);
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .time-card:hover {
        transform: translateY(-2px);
        border-color: var(--theme-color);
        box-shadow: 0 8px 25px rgba(var(--theme-color-rgb), 0.2);
      }

      .time-card.selected {
        border: 2px solid var(--selected-color);
        background: rgba(33, 150, 243, 0.1);
      }

      .time-card.current {
        border: 2px solid var(--neutral-color);
        background: rgba(255, 152, 0, 0.1);
      }

      .time-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .time-name {
        font-size: 1.2rem;
        font-weight: bold;
        color: var(--theme-color);
      }

      .time-period {
        font-size: 0.9rem;
        color: var(--text-secondary);
        background: var(--bg-primary);
        padding: 4px 8px;
        border-radius: 12px;
      }

      .time-sacrifice-status {
        font-size: 0.9rem;
        padding: 5px 10px;
        border-radius: 6px;
        text-align: center;
        margin-bottom: 8px;
      }

      .time-sacrifice-status.suitable {
        background: rgba(76, 175, 80, 0.2);
        color: var(--auspicious-color);
        border: 1px solid var(--auspicious-color);
      }

      .time-sacrifice-status.unsuitable {
        background: rgba(244, 67, 54, 0.2);
        color: var(--inauspicious-color);
        border: 1px solid var(--inauspicious-color);
      }

      .time-sacrifice-status.neutral {
        background: rgba(255, 152, 0, 0.2);
        color: var(--neutral-color);
        border: 1px solid var(--neutral-color);
      }

      .loading,
      .error {
        text-align: center;
        padding: 40px;
        font-size: 1.1rem;
      }

      .error {
        color: var(--inauspicious-color);
        background: rgba(244, 67, 54, 0.1);
        border-radius: 10px;
        border: 1px solid var(--inauspicious-color);
      }

      @media (max-width: 768px) {
        .controls {
          flex-direction: column;
          gap: 15px;
        }

        .time-details {
          grid-template-columns: 1fr;
        }

        .all-times-grid {
          grid-template-columns: 1fr;
        }

        .header h1 {
          font-size: 2rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header class="header">
        <h1>ğŸ—“ï¸ è¾²æ›†æ™‚è¾°å®œå¿ŒæŸ¥è©¢</h1>
        <div class="controls">
          <div class="input-group">
            <label for="date-input">é¸æ“‡æ—¥æœŸ</label>
            <input type="date" id="date-input" class="date-input" />
          </div>
          <div class="input-group">
            <label for="time-select">é¸æ“‡æ™‚è¾°</label>
            <select id="time-select" class="time-select">
              <option value="0">å­æ™‚ (23:00-00:59)</option>
              <option value="1">ä¸‘æ™‚ (01:00-02:59)</option>
              <option value="2">å¯…æ™‚ (03:00-04:59)</option>
              <option value="3">å¯æ™‚ (05:00-06:59)</option>
              <option value="4">è¾°æ™‚ (07:00-08:59)</option>
              <option value="5">å·³æ™‚ (09:00-10:59)</option>
              <option value="6">åˆæ™‚ (11:00-12:59)</option>
              <option value="7">æœªæ™‚ (13:00-14:59)</option>
              <option value="8">ç”³æ™‚ (15:00-16:59)</option>
              <option value="9">é…‰æ™‚ (17:00-18:59)</option>
              <option value="10">æˆŒæ™‚ (19:00-20:59)</option>
              <option value="11">äº¥æ™‚ (21:00-22:59)</option>
            </select>
          </div>
          <button onclick="queryDateTime()" class="query-btn">æŸ¥è©¢</button>
        </div>
        <div class="date-info" id="date-info"></div>
      </header>

      <div id="loading" class="loading" style="display: none">
        <p>æ­£åœ¨è¼‰å…¥è¾²æ›†è³‡æ–™...</p>
      </div>

      <div id="error" class="error" style="display: none"></div>

      <div id="content" style="display: none">
        <!-- é¸å®šæ™‚è¾°è©³ç´°ä¿¡æ¯ -->
        <div class="selected-time-info" id="selected-time-info">
          <h3><span>ğŸ•</span>é¸å®šæ™‚è¾°è©³æƒ…</h3>
          <div id="selected-time-content"></div>
        </div>

        <!-- æ‰€æœ‰æ™‚è¾°æ¦‚è¦½ -->
        <div class="all-times-grid" id="all-times-grid"></div>
      </div>
    </div>

    <script type="module">
      // å°å…¥ tyme4ts åº«
      // å…¨åŸŸè®Šæ•¸
      let tyme = null;

      // æ™‚è¾°åç¨±å’Œæ™‚é–“æ®µ
      const timeNames = [
        "å­",
        "ä¸‘",
        "å¯…",
        "å¯",
        "è¾°",
        "å·³",
        "åˆ",
        "æœª",
        "ç”³",
        "é…‰",
        "æˆŒ",
        "äº¥",
      ];
      const timePeriods = [
        "23:00-00:59",
        "01:00-02:59",
        "03:00-04:59",
        "05:00-06:59",
        "07:00-08:59",
        "09:00-10:59",
        "11:00-12:59",
        "13:00-14:59",
        "15:00-16:59",
        "17:00-18:59",
        "19:00-20:59",
        "21:00-22:59",
      ];

      let currentLunarDay = null;
      let selectedTimeIndex = 0;

      // åˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", async function () {
        try {
          // è¼‰å…¥ tyme4ts åº«
          tyme = await import("./tyme4ts.mjs");
          console.log("tyme4ts åº«è¼‰å…¥æˆåŠŸ");

          // åˆå§‹åŒ–æ—¥æœŸæ™‚é–“
          initializeDateTime();
          queryDateTime();
        } catch (error) {
          console.error("tyme4ts åº«è¼‰å…¥å¤±æ•—:", error);
          showError("tyme4ts åº«è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºä¿åœ¨ HTTP æœå‹™å™¨ç’°å¢ƒä¸‹é‹è¡Œæ­¤é é¢");
        }
      });

      // åˆå§‹åŒ–æ—¥æœŸå’Œæ™‚è¾°
      function initializeDateTime() {
        const now = new Date();

        // è¨­å®šæ—¥æœŸ
        const dateInput = document.getElementById("date-input");
        dateInput.value = now.toISOString().split("T")[0];

        // è¨­å®šç•¶å‰æ™‚è¾°
        const timeSelect = document.getElementById("time-select");
        const currentTimeIndex = getCurrentTimeIndex(now.getHours());
        timeSelect.value = currentTimeIndex;
        selectedTimeIndex = currentTimeIndex;

        console.log("åˆå§‹åŒ–å®Œæˆ - ç•¶å‰æ™‚è¾°:", timeNames[currentTimeIndex]);
      }

      // æ ¹æ“šå°æ™‚ç²å–æ™‚è¾°ç´¢å¼•
      function getCurrentTimeIndex(hour) {
        if (hour >= 23 || hour < 1) return 0; // å­æ™‚
        if (hour >= 1 && hour < 3) return 1; // ä¸‘æ™‚
        if (hour >= 3 && hour < 5) return 2; // å¯…æ™‚
        if (hour >= 5 && hour < 7) return 3; // å¯æ™‚
        if (hour >= 7 && hour < 9) return 4; // è¾°æ™‚
        if (hour >= 9 && hour < 11) return 5; // å·³æ™‚
        if (hour >= 11 && hour < 13) return 6; // åˆæ™‚
        if (hour >= 13 && hour < 15) return 7; // æœªæ™‚
        if (hour >= 15 && hour < 17) return 8; // ç”³æ™‚
        if (hour >= 17 && hour < 19) return 9; // é…‰æ™‚
        if (hour >= 19 && hour < 21) return 10; // æˆŒæ™‚
        if (hour >= 21 && hour < 23) return 11; // äº¥æ™‚
        return 0;
      }

      // æŸ¥è©¢æ—¥æœŸæ™‚è¾°
      async function queryDateTime() {
        if (!tyme) {
          showError("tyme4ts åº«å°šæœªè¼‰å…¥ï¼Œè«‹ç¨å¾Œå†è©¦");
          return;
        }

        const dateInput = document.getElementById("date-input");
        const timeSelect = document.getElementById("time-select");

        const selectedDate = new Date(dateInput.value);
        selectedTimeIndex = parseInt(timeSelect.value);

        if (isNaN(selectedDate.getTime())) {
          showError("è«‹é¸æ“‡æœ‰æ•ˆçš„æ—¥æœŸ");
          return;
        }

        showLoading();

        try {
          console.log(
            "æŸ¥è©¢æ—¥æœŸ:",
            selectedDate,
            "æ™‚è¾°ç´¢å¼•:",
            selectedTimeIndex
          );

          // ä½¿ç”¨ tyme4ts ç²å–è¾²æ›†è³‡æ–™
          const solar = tyme.SolarDay.fromYmd(
            selectedDate.getFullYear(),
            selectedDate.getMonth() + 1,
            selectedDate.getDate()
          );

          currentLunarDay = solar.getLunarDay();
          console.log("è¾²æ›†æ—¥æœŸå°è±¡:", currentLunarDay);

          // æ›´æ–°é é¢å…§å®¹
          updateDateInfo(solar, currentLunarDay);
          updateSelectedTimeInfo();
          updateAllTimesGrid();

          showContent();
        } catch (error) {
          console.error("æŸ¥è©¢å¤±æ•—:", error);
          showError("æŸ¥è©¢è¾²æ›†è³‡æ–™å¤±æ•—ï¼š" + error.message);
        }
      }

      // æ›´æ–°æ—¥æœŸè³‡è¨Š
      function updateDateInfo(solar, lunar) {
        const dateInfo = document.getElementById("date-info");
        const solarStr = `${solar.getYear()}å¹´${solar.getMonth()}æœˆ${solar.getDay()}æ—¥`;
        const lunarStr = `${lunar.getYear()}å¹´${lunar.getMonth()}æœˆ${lunar.getDay()}æ—¥`;
        const weekday = solar.getWeek().getName();

        dateInfo.innerHTML = `
                <div><strong>å…¬æ›†:</strong> ${solarStr} (${weekday})</div>
                <div><strong>è¾²æ›†:</strong> ${lunarStr}</div>
            `;
      }

      // æ›´æ–°é¸å®šæ™‚è¾°ä¿¡æ¯
      function updateSelectedTimeInfo() {
        if (!currentLunarDay) return;

        const selectedTimeContent = document.getElementById(
          "selected-time-content"
        );
        const timeName = timeNames[selectedTimeIndex];
        const timePeriod = timePeriods[selectedTimeIndex];

        try {
          const lunarHours = currentLunarDay.getHours();
          const lunarHour = lunarHours[selectedTimeIndex];

          if (!lunarHour) {
            selectedTimeContent.innerHTML = "<p>ç„¡æ³•ç²å–è©²æ™‚è¾°çš„è³‡æ–™</p>";
            return;
          }

          const recommends = lunarHour
            .getRecommends()
            .map((item) => item.getName());
          const avoids = lunarHour.getAvoids().map((item) => item.getName());
          const sacrificeStatus = analyzeSacrificeStatus(recommends, avoids);

          selectedTimeContent.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="color: var(--selected-color); font-size: 1.4rem;">${timeName}æ™‚ (${timePeriod})</h4>
                        <div class="sacrifice-status ${sacrificeStatus.class}">
                            <span>${sacrificeStatus.icon}</span>
                            <span>${sacrificeStatus.text}</span>
                        </div>
                    </div>
                    <div class="time-details">
                        <div class="yi-ji-section yi-section">
                            <h4>âœ… å®œäº‹</h4>
                            <div class="yi-ji-items">
                                ${
                                  recommends.length > 0
                                    ? recommends
                                        .map(
                                          (item) =>
                                            `<span class="yi-item">${item}</span>`
                                        )
                                        .join("")
                                    : '<span style="color: var(--text-secondary);">ç„¡ç‰¹åˆ¥å®œäº‹</span>'
                                }
                            </div>
                        </div>
                        <div class="yi-ji-section ji-section">
                            <h4>âŒ å¿Œäº‹</h4>
                            <div class="yi-ji-items">
                                ${
                                  avoids.length > 0
                                    ? avoids
                                        .map(
                                          (item) =>
                                            `<span class="ji-item">${item}</span>`
                                        )
                                        .join("")
                                    : '<span style="color: var(--text-secondary);">ç„¡ç‰¹åˆ¥å¿Œäº‹</span>'
                                }
                            </div>
                        </div>
                    </div>
                    <div class="sacrifice-analysis">
                        <h4 style="color: var(--theme-color); margin-bottom: 8px;">ğŸ™ ç¥­ç¥€å»ºè­°</h4>
                        <p style="line-height: 1.6;">${
                          sacrificeStatus.advice
                        }</p>
                    </div>
                `;
        } catch (error) {
          console.error("æ›´æ–°é¸å®šæ™‚è¾°ä¿¡æ¯å¤±æ•—:", error);
          selectedTimeContent.innerHTML =
            '<p style="color: var(--inauspicious-color);">è¼‰å…¥æ™‚è¾°è³‡æ–™å¤±æ•—</p>';
        }
      }

      // æ›´æ–°æ‰€æœ‰æ™‚è¾°ç¶²æ ¼
      function updateAllTimesGrid() {
        if (!currentLunarDay) return;

        const allTimesGrid = document.getElementById("all-times-grid");
        const currentHour = new Date().getHours();
        const currentTimeIndex = getCurrentTimeIndex(currentHour);

        try {
          const lunarHours = currentLunarDay.getHours();
          let gridHtml = "";

          for (let i = 0; i < 12; i++) {
            const timeName = timeNames[i];
            const timePeriod = timePeriods[i];
            const lunarHour = lunarHours[i];

            let cardClasses = "time-card";
            let timeLabel = `${timeName}æ™‚`;

            if (i === selectedTimeIndex) {
              cardClasses += " selected";
              timeLabel += " (æŸ¥è©¢ä¸­)";
            } else if (i === currentTimeIndex) {
              cardClasses += " current";
              timeLabel += " (ç¾åœ¨)";
            }

            let sacrificeStatusHtml = "";
            if (lunarHour) {
              const recommends = lunarHour
                .getRecommends()
                .map((item) => item.getName());
              const avoids = lunarHour
                .getAvoids()
                .map((item) => item.getName());
              const sacrificeStatus = analyzeSacrificeStatus(
                recommends,
                avoids
              );

              sacrificeStatusHtml = `
                            <div class="time-sacrifice-status ${sacrificeStatus.class}">
                                ${sacrificeStatus.icon} ${sacrificeStatus.text}
                            </div>
                        `;
            }

            gridHtml += `
                        <div class="${cardClasses}" onclick="selectTime(${i})">
                            <div class="time-card-header">
                                <div class="time-name">${timeLabel}</div>
                                <div class="time-period">${timePeriod}</div>
                            </div>
                            ${sacrificeStatusHtml}
                        </div>
                    `;
          }

          allTimesGrid.innerHTML = gridHtml;
        } catch (error) {
          console.error("æ›´æ–°æ™‚è¾°ç¶²æ ¼å¤±æ•—:", error);
          allTimesGrid.innerHTML = '<div class="error">è¼‰å…¥æ™‚è¾°è³‡æ–™å¤±æ•—</div>';
        }
      }

      // åˆ†æç¥­ç¥€é©å®œæ€§
      function analyzeSacrificeStatus(recommends, avoids) {
        const sacrificeKeywords = [
          "ç¥­ç¥€",
          "ç¥ˆç¦",
          "æ‹œç¥",
          "ç¥­æ‹œ",
          "ä¸Šé¦™",
          "ç‡’é¦™",
          "æ•¬ç¥",
          "ç¥ˆé¡˜",
          "ç¥ˆç¦±",
        ];

        const suitableForSacrifice = recommends.some((item) =>
          sacrificeKeywords.some((keyword) => item.includes(keyword))
        );

        const tabooForSacrifice = avoids.some((item) =>
          sacrificeKeywords.some((keyword) => item.includes(keyword))
        );

        if (suitableForSacrifice) {
          return {
            class: "suitable",
            icon: "âœ…",
            text: "é©åˆç¥­ç¥€",
            advice:
              "æ­¤æ™‚è¾°é©å®œç¥­ç¥€ç¥ˆç¦ï¼Œå¯é€²è¡Œç¥­æ‹œå„€å¼ï¼Œæº–å‚™é¦™ç‡­ä¾›å“ï¼Œè™”èª ç¥­æ‹œå¯å¾—ç¥éˆåº‡ä½‘ã€‚",
          };
        } else if (tabooForSacrifice) {
          return {
            class: "unsuitable",
            icon: "âŒ",
            text: "ä¸å®œç¥­ç¥€",
            advice: "æ­¤æ™‚è¾°ä¸å®œé€²è¡Œç¥­ç¥€æ´»å‹•ï¼Œå»ºè­°é¸æ“‡å…¶ä»–æ™‚è¾°ï¼Œä»¥å…è¡æ’ç¥éˆã€‚",
          };
        } else {
          return {
            class: "neutral",
            icon: "âš ï¸",
            text: "å¯è¬¹æ…ç¥­ç¥€",
            advice:
              "æ­¤æ™‚è¾°ç„¡æ˜ç¢ºç¥­ç¥€å®œå¿Œï¼Œå¯é€²è¡Œä¸€èˆ¬æ€§ç¥­æ‹œï¼Œä½†éœ€ä¿æŒæ­æ•¬è™”èª ä¹‹å¿ƒã€‚",
          };
        }
      }

      // é¸æ“‡æ™‚è¾°
      function selectTime(timeIndex) {
        selectedTimeIndex = timeIndex;
        const timeSelect = document.getElementById("time-select");
        timeSelect.value = timeIndex;

        updateSelectedTimeInfo();
        updateAllTimesGrid();
      }

      // é¡¯ç¤ºè¼‰å…¥ä¸­
      function showLoading() {
        document.getElementById("loading").style.display = "block";
        document.getElementById("error").style.display = "none";
        document.getElementById("content").style.display = "none";
      }

      // é¡¯ç¤ºéŒ¯èª¤
      function showError(message) {
        document.getElementById("loading").style.display = "none";
        document.getElementById("error").style.display = "block";
        document.getElementById("error").textContent = message;
        document.getElementById("content").style.display = "none";
      }

      // é¡¯ç¤ºå…§å®¹
      function showContent() {
        document.getElementById("loading").style.display = "none";
        document.getElementById("error").style.display = "none";
        document.getElementById("content").style.display = "block";
      }

      // å°‡å‡½æ•¸æš´éœ²åˆ°å…¨åŸŸä½œç”¨åŸŸ
      window.queryDateTime = queryDateTime;
      window.selectTime = selectTime;
    </script>
  </body>
</html>
